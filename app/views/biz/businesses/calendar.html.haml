#processmessage
  %span.msg Loading...
.lightscreen

=render :partial => "header"

%h3.instructions
  Create Deals to drive traffic to your business. Select a discount, the maximum number of coupons per day, and the times youâ€™d like the coupon to be valid. 
  Then just apply that deal to the dates on the calendar.

-calendar_start = [(@business.deal_events.minimum(:created_at) || Time.now).calendar_start, Time.now.calendar_start].min
-calendar_end = calendar_start + 4.months
#calendar.clearfix{'data-start-date' => calendar_start.strftime('%B %d, %Y'), 'data-end-date' => calendar_end.strftime('%B %d, %Y')}
  =render :partial => "/biz/deal_templates/form"
  .section.left
    .title.clearfix
      %h1 My Deals
    %ul.templates.loading{"data-src" => biz_business_templates_path(@business)}
      .empty_message
        %h3 No Deals
        %p 
          Create a deal using the button below. 
        %p 
          Set the parameters of your deal, then apply it to dates 
          using the calendar on the right.
    %a.btngrypill200x30.new.center{:href => "#", "data-popover" => "#newdealtpl", "data-popover-title" => "New Deal", "data-popover-pos" => ",top"}
      %span.plus + 
      New Deal
    
  .section.right
    .title.clearfix
      %h1.gridtitle
        ="#{Date::MONTHNAMES[calendar_start.month]} #{calendar_start.year}"

    .grid.loading{'data-src' => biz_business_deals_path(@business)}      
      .table
        .thead
          .tr
            -Date::DAYNAMES.each_with_index do |dow, i|
              .th{:class => 'dow', :id => "dow_#{i}", 'data-dayindex' => i, 'data-dayname' => dow.to_s.downcase}
                =dow.to_s.downcase
        .tbody
      #messages
        .cancel
        .content
      
  %script.jstpl.template{:type => "text/x-jquery-tmpl"}
    =render :partial => "/biz/deal_templates/template", :object => nil
  %script.jstpl.event{:type => "text/x-jquery-tmpl"}
    .event{:style => "border-color: ${color}; color: ${color}; background-color: ${color};", 'data-template-id' => '${deal_template_id}'}
      %h2 ${name}
      .timeframe ${timeframe}
  %script.jstpl.datedetail{:type => "text/x-jquery-tmpl"}
    .datedetail{'data-date' => '${date}'}
      {{html events}}
      =form_tag codes_biz_business_path(@business), :class => "sendcodes", :method => :get do
        =hidden_field_tag :date, '${date}'
        =button_tag :class => "btngrypill" do
          Send Discount Codes

  %script.jstpl.eventdetails{:type => "text/x-jquery-tmpl"}
    .event.clearfix{'data-template-id' => '${deal_template_id}'}
      .color{:style => "background:${color}"}
      %h2 ${name}
      %h3 ${summary}
      %h3 ${sale_count} of ${deal_count} sold, ${remaining_count} remaining
      {{if removed_at}}
      .removed
        Cancelled
      {{else}}
      =form_tag CGI.unescape(biz_business_deal_path(@business, '${id}')), :method => "delete", :class => "remove" do
        =button_tag :class => "withx btngrypill" do
          %span.redx
            &times;
          Cancel Remaining
      {{/if}}