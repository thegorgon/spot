=content_for :bgimage do
  .stretcher{'data-gravity' => "0.5x0.5"}
    =image_tag "stretcher/event/photo#{@promotion.id.modulo(4) + 1}.jpg", :size => "2292x1524"

=content_for :above do
  -unless current_member?
    .overlay.clearfix
      .title.clearfix
        %h1.tf.left Get unlimited access to unforgettable experiences like this
        =button_tag :class => "btnorg170x41 btnmembership tf right" do
          apply now

=content_for :toptitle do
  -if @city
    =link_to @city.name.titlecase, city_path(@city)
    ⋅
  =@promotion.business.place.name
  ⋅
  =@promotion.name
    
.evtdis
  .image=image_tag @place.image.url(:i640x400), :size => "856x535"
.details.clearfix
  .event
    %h1.name.tf=@promotion.name
    .description=@promotion.description.html_safe
  .place
    .info.address.clearfix
      %h1.tf=@place.name
      -@place.address_lines.each_with_index do |line, i|
        %p.line.clearfix
          .left=line
          -if @place.address_lines.length - 1 == i
            .left.mapit="( #{link_to "map it", gmap_url(@place)} )".html_safe
    .info.phone=phone_link(@place.phone_number)
    .info.wishlists="#{@place.wishlist_count} Wishlists"
    -if @place.external_place(:google)
      =link_to "more info from google", external_place_url(@place.external_place(:google)), :class => "info google"
    -if @place.external_place(:yelp)
      =link_to "reviews on yelp", external_place_url(@place.external_place(:yelp)), :class => "info yelp"

-if current_member?
  %hr
-else
  .overlay.clearfix
    %h1.left.tf Exclusively available to Spot Members. 
    =button_tag :class => "btnorg170x41 btnmembership tf right" do
      apply now

.availability.clearfix
  -unless current_member?
    .shield
      
  .dates
    .title.tf
      Reserve this experience. Click an available date : 
    .calendar.clearfix
      -events = @promotion.events.upcoming.hash_by { |e| e.date }          
      -startdate = Date.today.sunday
      -startdate = startdate > Date.today ? Date.today.sunday - 1.week : Date.today.sunday
      -enddate = ([startdate + 2.weeks, @promotion.events.upcoming.last.date].max).saturday
      -(startdate..enddate).each_with_index do |date, i|
        -week = (i/7).floor
        -lastweek = enddate.to_time - date.to_time < 1.week
        -event = events[date]
        .date{:class => "#{conditionally("visible", week < 2)} wday#{date.wday} wk#{week} #{conditionally("lastwk", lastweek)}"}
          .dow.tf=date.strftime('%a').upcase
          .doy.tf=date.day.ordinalize
          -if event
            .event
              %a{:href => "#", :class => current_member?? "btnclaim" : "btnmembership"}
                .text="#{event.count} left"
                -if current_member?
                  .claim claim
                -else
                  .join join spot
  
    .subtitles.clearfix
      .left
        -if enddate > startdate + 2.weeks
          =link_to "more", "#", :rel => ".availability", "data-toggle-class" => "showall", :class => "show"
          =link_to "fewer", "#", :rel => ".availability", "data-toggle-class" => "showall", :class => "hide"
  .hours
    .clock
      .hands
        %canvas{:id => "timewedge", :height => "150", :width => "150", "data-start-hour" => @promotion.start_time, "data-end-hour" => @promotion.end_time}
          =image_tag "icons/clockhandsgry150x150.png", :size => "150x150"
      .ring=image_tag "icons/clockringgry150x150.png", :size => "150x150"
    .timeframe.tf=@promotion.timeframe

.explanations.clear.clearfix
  =render :partial => "/site/shared/explanations/howitworks"
  =render :partial => "/site/shared/explanations/fineprint"
  =render :partial => "/site/shared/explanations/guarantee"

#applydialog.applydialog.clearfix.hidden{"data-title" => "Become a Spot Member"}
  =render :partial => "/shared/membership/apply"